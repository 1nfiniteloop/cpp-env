#!/bin/bash

readonly gtest_version=1.11.0
readonly boost_version=1.79.0

get_host_install_dir()
{
  local host_system="$(uname -s)"
  local host_system_processor="$(uname -m)"
  source /etc/os-release
  get_install_dir "${host_system}-${ID}" "${host_system_processor}"
}

get_install_dir()
{
  local system="${1}"
  local system_processor="${2}"
  echo "${THIRD_PARTY_ROOT}/install/${system}/${system_processor}"
}

readonly source_dir="${THIRD_PARTY_ROOT}/source"
readonly host_install_dir="$(get_host_install_dir)"

fetch_gtest()
{
  curl \
      --silent \
      --location \
      https://github.com/google/googletest/archive/release-${gtest_version}.tar.gz \
      | tar -xz --directory ${source_dir}
}

install_gtest()
{
  mkdir --parents ${source_dir}/googletest-release-${gtest_version}/build \
      && cd ${source_dir}/googletest-release-${gtest_version}/build \
      && cmake .. \
      && make install DESTDIR=${host_install_dir}/googletest-${gtest_version}
}

gtest()
{
  fetch_gtest && install_gtest
}

fetch_boost()
{
  local ver="${boost_version//./_}"
  curl \
      --silent \
      --location \
      https://boostorg.jfrog.io/artifactory/main/release/${boost_version}/source/boost_${ver}.tar.gz \
      |tar -xz --directory ${source_dir}
}

install_boost()
{
  local ver="${boost_version//./_}"
  local workdir="${source_dir}/boost_${ver}"
  cd ${workdir} \
    && ./bootstrap.sh \
    && ./b2 install \
       --prefix=${host_install_dir}/boost_${ver} \
       --with-program_options
}

boost()
{
  fetch_boost && install_boost
}

all()
{
  mkdir --parents ${source_dir} ${host_install_dir} \
    && gtest \
    && boost
}

if [[ -z "${THIRD_PARTY_ROOT}" ]]; then
  echo "Environment variable THIRD_PARTY_ROOT not set"
  exit 1
elif [[ ${#} -eq 0 ]]; then
  all
else
  # execute functions individually from cmdline args:
  for fcn in "${@}"; do
    echo "* ${fcn}"
    ${fcn}
  done
fi
